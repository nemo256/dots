#!/usr/bin/env bash

# Env vars
USERNAME=n3m0
SHELL=/bin/bash
# Github token (optional)
TOKEN=

# Cool logo message
function logo() {
    local text=$1

    local blue=$(tput setaf 4; tput bold)
    local indigo=$(tput setaf 55; tput bold)
    local text_color=$(tput bold)

    local screen_width=$(tput cols)
    local logo="
███    ██ ██████  ███    ███  ██████      ██████   ██████  ████████ ███████ 
████   ██      ██ ████  ████ ██  ████     ██   ██ ██    ██    ██    ██      
██ ██  ██  █████  ██ ████ ██ ██ ██ ██     ██   ██ ██    ██    ██    ███████ 
██  ██ ██      ██ ██  ██  ██ ████  ██     ██   ██ ██    ██    ██         ██ 
██   ████ ██████  ██      ██  ██████      ██████   ██████     ██    ███████ 
"
    local logo_width=$(echo "$logo" | awk '{ if (length > max) max = length } END { print max }')

    clear

    IFS=$'\n'
    printf "\n"
    for line in $logo
    do
        printf "%*s%s\n" $((($screen_width - ${#line} - 1) / 2)) "" "$indigo$line"
    done

    printf "\n%*s%s%s%*s\n\n" $((($screen_width - ${#text} - 1) / 2)) "" "$blue" "$text" $((($screen_width + ${#text} + ${#text} - $logo_width) / 2)) ""

    tput sgr0
}

logo "Press any key to continue..."
read

if [[ ! -f "packages" ]]; then
  logo "Error: packages file not found!"
  exit 1
fi

logo "Applying custom grub configuration..."
sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="[^"]*/& rootflags=data=writeback libata.force=1:noncq acpi_osi=!Darwin/' /etc/default/grub 1> /dev/null
sudo sed -i 's/^GRUB_TIMEOUT=5/GRUB_TIMEOUT=0/' /etc/default/grub 1> /dev/null
sudo sed -i 's/^#GRUB_DISABLE_SUBMENU=y/GRUB_DISABLE_SUBMENU=y/' /etc/default/grub 1> /dev/null
sudo grub-mkconfig -o /boot/grub/grub.cfg 1> /dev/null

while read line
do
  if [[ $line == "" ]] || [[ $line == \#* ]]; then
    continue
  fi
  logo "Installing: $line..."
  sudo pacman -Sy --noconfirm --needed "$line" 1> /dev/null
done < packages

logo "Switch shell to '${SHELL}'..."
sudo chsh -s ${SHELL} root 1> /dev/null
sudo chsh -s ${SHELL} ${USERNAME} 1> /dev/null

logo "Changing default console font..."
sudo echo -ne 'KEYMAP="us"
FONT="ter-132b"
' > /etc/vconsole.conf

logo "Adding no password sudo rights..."
sudo sed -ni "/^root/{a\
  ${USERNAME} ALL=(ALL:ALL) NOPASSWD: ALL
p}" /etc/sudoers

logo "Github configuration..."
if [ -v TOKEN ]; then
  cd ${HOME} 1> /dev/null
  echo -ne "https://nemo256:${TOKEN}@github.com" > ${HOME}/.git-credentials
  git config --global credential.helper store 1> /dev/null
fi

logo "Font configuration..."
cd /usr/share/fonts 1> /dev/null
sudo curl -fLo "Fira Code Bold Nerd Font Complete.ttf" https://github.com/ryanoasis/nerd-fonts/raw/HEAD/patched-fonts/FiraCode/Bold/complete/Fira%20Code%20Bold%20Nerd%20Font%20Complete.ttf 1> /dev/null
sudo fc-cache -fv 1> /dev/null
cd ${HOME} 1> /dev/null

logo "Cloning Documents..."
[[ ! -d Documents ]] && git clone https://github.com/nemo256/Documents 1> /dev/null
logo "Cloning Pictures..."
[[ ! -d Pictures ]] && git clone https://github.com/nemo256/Pictures 1> /dev/null
logo "Cloning Music..."
[[ ! -d Music ]] && git clone https://github.com/nemo256/Music 1> /dev/null
logo "Cloning Templates..."
[[ ! -d Templates ]] && git clone https://github.com/nemo256/Templates 1> /dev/null
logo "Creating .build folder..."
[[ ! -d .build ]] && mkdir .build 1> /dev/null
cd .build 1> /dev/null
logo "Cloning tily (Custom dwm fork)..."
[[ ! -d tily ]] && git clone https://github.com/nemo256/tily 1> /dev/null
logo "Cloning st..."
[[ ! -d st ]] && git clone https://github.com/nemo256/st 1> /dev/null
logo "Cloning dmenu..."
[[ ! -d dmenu ]] && git clone https://github.com/nemo256/dmenu 1> /dev/null
logo "Cloning slock..."
[[ ! -d slock ]] && git clone https://github.com/nemo256/slock 1> /dev/null
logo "Cloning slstatus..."
[[ ! -d slstatus ]] && git clone https://github.com/nemo256/slstatus 1> /dev/null
logo "Cloning fetchy..."
[[ ! -d fetchy ]] && git clone https://github.com/nemo256/fetchy 1> /dev/null
logo "Cloning ani-cli..."
[[ ! -d ani-cli ]] && git clone https://github.com/pystardust/ani-cli 1> /dev/null
logo "Cloning tty-clock..."
[[ ! -d tty-clock ]] && git clone https://github.com/xorg62/tty-clock 1> /dev/null
logo "Cloning grabc..."
[[ ! -d grabc ]] && git clone https://github.com/muquit/grabc 1> /dev/null
logo "Cloning tremc..."
[[ ! -d tremc ]] && git clone https://github.com/tremc/tremc 1> /dev/null
logo "Installing tily..."
cd tily && sudo make clean install 1> /dev/null
logo "Installing st..."
cd ../st && sudo make clean install 1> /dev/null
logo "Installing dmenu..."
cd ../dmenu && sudo make clean install 1> /dev/null
logo "Installing slock..."
cd ../slock && sudo make clean install 1> /dev/null
logo "Installing slstatus..."
cd ../slstatus && sudo make clean install 1> /dev/null
logo "Installing fetchy..."
cd ../fetchy && sudo make clean install 1> /dev/null
logo "Installing ani-cli..."
cd ../ani-cli && sudo chmod +x ani-cli && sudo cp -fvr ani-cli /usr/local/bin/ani-cli 1> /dev/null
logo "Installing tty-clock..."
cd ../tty-clock && make && sudo make install 1> /dev/null
logo "Installing grabc..."
cd ../grabc && make && sudo make install 1> /dev/null
logo "Installing tremc..."
cd ../tremc && sudo make install 1> /dev/null
logo "Installing alder..."
yarn global add @aweary/alder 1> /dev/null
logo "Installing weather-cli..."
yarn global add weather-cli 1> /dev/null

logo "Restoring home directory..."
cd ${HOME} && mkdir Videos Work 1> /dev/null

logo "Stowing configuration files..."
rm -fvr ${HOME}/.bash*
rm -fvr ${HOME}/.gitconfig
rm -fvr ${HOME}/.config/*

cd ${HOME}/dots

stow abook
stow bin
stow bash
stow dunst
stow git
stow gtk-2.0
stow gtk-3.0
stow htop
stow mpv
stow ncmpcpp
stow newsboat
stow nvim
stow picom
stow ranger
stow sxiv
stow transmission-daemon
stow tremc
stow xinit
stow zathura

chmod -R 755 ${HOME}/bin

echo -ne "
------------------------------------------------------------------------------------------
                                   Vimy Configuration
------------------------------------------------------------------------------------------
"
git clone https://github.com/nemo256/vimy \
  ${HOME}/.config/nvim
git clone --depth 1 https://github.com/wbthomason/packer.nvim \
  ${HOME}/.local/share/nvim/site/pack/packer/start/packer.nvim
nvim --headless -c 'autocmd User PackerComplete quitall' -c 'PackerSync'

echo -ne "
------------------------------------------------------------------------------------------
                                   Ranger Configuration
------------------------------------------------------------------------------------------
"
git clone https://github.com/alexanderjeurissen/ranger_devicons \
  ${HOME}/.config/ranger/plugins/ranger_devicons
cd ${HOME}/.config/ranger/plugins/ranger_devicons/
python -m devicons
cd ${HOME}

echo -ne "
------------------------------------------------------------------------------------------
                                       Dots setup
------------------------------------------------------------------------------------------
                                  Done - Please Reboot

"

